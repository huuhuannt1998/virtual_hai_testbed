# ==============================================================================
# P3 (Water Treatment) Baseline Evaluation Configuration
# ==============================================================================
# Primary evaluation configuration for P3 water treatment subprocess.
# This is the main benchmark used in the paper.

experiment:
  name: "p3_water_treatment_baseline"
  description: "Primary evaluation for P3 water treatment control with safety shields"
  seed: 42
  device: "cuda"
  
schema:
  path: "../schemas/p3.yaml"

data:
  csv_path: "data/hai/train_p3.csv"
  val_csv_path: "data/hai/val_p3.csv"
  test_csv_path: "data/hai/test_p3.csv"
  output_dir: "data/processed/p3"
  
  normalize: true
  reward_scale: 1.0
  terminal_threshold: 0.15
  
  train_frac: 0.7
  val_frac: 0.15
  test_frac: 0.15

environment:
  max_steps: 3600
  action_repeat: 1
  frame_stack: 1
  reward_shaping: true
  
  attack:
    enabled: false
    type: null
    params: {}

bc:
  enabled: true
  
  hidden_dims: [256, 256, 256]
  activation: "relu"
  dropout: 0.1
  
  batch_size: 256
  learning_rate: 3.0e-4
  weight_decay: 1.0e-4
  n_epochs: 100
  early_stopping_patience: 10
  
  grad_clip_norm: 1.0
  
  model_path: "models/p3/bc/policy.pt"
  log_dir: "logs/p3/bc"

offline_rl:
  enabled: true
  
  algorithms:
    - name: "td3bc"
      enabled: true
      params:
        alpha: 2.5
        actor_lr: 3.0e-4
        critic_lr: 3.0e-4
        tau: 0.005
        gamma: 0.99
        n_critics: 2
        hidden_dims: [256, 256]
        
    - name: "cql"
      enabled: true
      params:
        alpha: 5.0
        actor_lr: 3.0e-4
        critic_lr: 3.0e-4
        tau: 0.005
        gamma: 0.99
        n_critics: 2
        hidden_dims: [256, 256]
        
    - name: "iql"
      enabled: true
      params:
        expectile: 0.7
        actor_lr: 3.0e-4
        critic_lr: 3.0e-4
        tau: 0.005
        gamma: 0.99
        hidden_dims: [256, 256]
  
  training:
    batch_size: 256
    n_steps: 100000
    eval_interval: 10000
    n_eval_episodes: 10
    grad_clip_norm: 1.0
    
  model_dir: "models/p3/offline_rl"
  log_dir: "logs/p3/offline_rl"

ope:
  enabled: true
  
  fqe:
    n_steps: 50000
    learning_rate: 3.0e-4
    batch_size: 256
    hidden_dims: [256, 256]
    gamma: 0.99
    
  wis:
    n_trajectories: 100
    
  bootstrap:
    n_bootstrap: 200
    confidence_level: 0.95
    
  gate:
    require_positive_lower_ci: true
    require_beat_bc: true
    
  output_csv: "results/p3_offline_leaderboard.csv"

shield:
  enabled: true
  use_schema_rules: true
  projection_method: "clip"
  max_delta_per_step: 0.1
  log_interventions: true
  intervention_penalty: -0.01

mpc:
  enabled: true
  
  dynamics:
    type: "mlp"
    hidden_dims: [256, 256]
    residual: true
    
    training:
      n_epochs: 50
      batch_size: 256
      learning_rate: 1.0e-3
      weight_decay: 1.0e-4
      val_frac: 0.1
      
    model_path: "models/p3/mpc/dynamics.pt"
    
  cem:
    horizon: 10
    n_candidates: 500
    n_elite: 50
    n_iterations: 5
    init_std: 0.3
    min_std: 0.01

online_eval:
  enabled: true
  
  n_episodes: 50
  max_steps_per_episode: 3600
  
  use_shield: true
  max_intervention_rate: 0.05
  
  metrics:
    - "itae"
    - "ise"
    - "overshoot"
    - "settling_time"
    - "wear"
    - "energy"
    - "violations"
    - "interventions"
    - "latency"
    
  output_csv: "results/p3_nominal.csv"

attack_eval:
  enabled: true
  
  attacks:
    - type: "hostile"
      params:
        adversary_magnitude: 0.5
        
    - type: "flood"
      params:
        flood_prob: 0.1
        
    - type: "bias"
      params:
        bias_magnitude: 0.2
        
    - type: "delay"
      params:
        delay_steps: 3
        
  n_episodes_per_attack: 20
  output_csv: "results/p3_attacks.csv"

cross_version:
  enabled: false
  versions:
    - "p3_v1"
    - "p3_v2"
  output_csv: "results/p3_cross_version.csv"

plots:
  enabled: true
  output_dir: "paper/figs"
  format: "pdf"
  dpi: 300
  
  figures:
    - type: "ope_scatter"
      output: "fig_p3_ope_scatter.pdf"
      
    - type: "latency_cdf"
      output: "fig_p3_latency_cdf.pdf"
      deadline_ms: 10.0
      
    - type: "interventions"
      output: "fig_p3_interventions.pdf"

logging:
  level: "INFO"
  log_to_file: true
  log_dir: "logs/p3"
  tensorboard: true
  wandb:
    enabled: false
    project: "hai-ml"
    entity: null
    
results:
  base_dir: "results/p3"
  save_trajectories: false
  save_models: true
